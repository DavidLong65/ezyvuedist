"use strict";(self.webpackChunkezyview=self.webpackChunkezyview||[]).push([[547],{9205:function(e,t,r){r.r(t),r.d(t,{Rhino3dmLoader:function(){return u}});var a=r(9439),n=r(5671),o=r(3144),s=r(136),i=r(7277),c=r(3272),l=new WeakMap,u=function(e){(0,s.Z)(r,e);var t=(0,i.Z)(r);function r(e){var a;return(0,n.Z)(this,r),(a=t.call(this,e)).libraryPath="",a.libraryPending=null,a.libraryBinary=null,a.libraryConfig={},a.url="",a.workerLimit=4,a.workerPool=[],a.workerNextTaskID=1,a.workerSourceURL="",a.workerConfig={},a.materials=[],a.warnings=[],a}return(0,o.Z)(r,[{key:"setLibraryPath",value:function(e){return this.libraryPath=e,this}},{key:"setWorkerLimit",value:function(e){return this.workerLimit=e,this}},{key:"load",value:function(e,t,r,a){var n=this,o=new c.hH6(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),this.url=e,o.load(e,(function(r){if(l.has(r))return l.get(r).promise.then(t).catch(a);n.decodeObjects(r,e).then((function(e){e.userData.warnings=n.warnings,t(e)})).catch((function(e){return a(e)}))}),r,a)}},{key:"debug",value:function(){console.log("Task load: ",this.workerPool.map((function(e){return e._taskLoad})))}},{key:"decodeObjects",value:function(e,t){var r,a,n=this,o=e.byteLength,s=this._getWorker(o).then((function(t){return r=t,a=n.workerNextTaskID++,new Promise((function(t,n){r._callbacks[a]={resolve:t,reject:n},r.postMessage({type:"decode",id:a,buffer:e},[e])}))})).then((function(e){return n._createGeometry(e.data)})).catch((function(e){throw e}));return s.catch((function(){return!0})).then((function(){r&&a&&n._releaseTask(r,a)})),l.set(e,{url:t,promise:s}),s}},{key:"parse",value:function(e,t,r){var a=this;this.decodeObjects(e,"").then((function(e){e.userData.warnings=a.warnings,t(e)})).catch((function(e){return r(e)}))}},{key:"_compareMaterials",value:function(e){var t={};t.name=e.name,t.color={},t.color.r=e.color.r,t.color.g=e.color.g,t.color.b=e.color.b,t.type=e.type;for(var r=0;r<this.materials.length;r++){var a=this.materials[r],n={};if(n.name=a.name,n.color={},n.color.r=a.color.r,n.color.g=a.color.g,n.color.b=a.color.b,n.type=a.type,JSON.stringify(t)===JSON.stringify(n))return a}return this.materials.push(e),e}},{key:"_createMaterial",value:function(e){if(void 0===e)return new c.Wid({color:new c.Ilk(1,1,1),metalness:.8,name:"default",side:2});var t=e.diffuseColor,r=new c.Ilk(t.r/255,t.g/255,t.b/255);0===t.r&&0===t.g&&0===t.b&&(r.r=1,r.g=1,r.b=1);for(var a=new c.Wid({color:r,name:e.name,side:2,transparent:e.transparency>0,opacity:1-e.transparency}),n=new c.dpR,o=0;o<e.textures.length;o++){var s=e.textures[o];if(null!==s.image){var i=n.load(s.image);switch(s.type){case"Diffuse":a.map=i;break;case"Bump":a.bumpMap=i;break;case"Transparency":a.alphaMap=i,a.transparent=!0;break;case"Emap":a.envMap=i}i.wrapS=0===s.wrapU?c.rpg:c.uWy,i.wrapT=0===s.wrapV?c.rpg:c.uWy,i.repeat.set(s.repeat[0],s.repeat[1])}}return a}},{key:"_createGeometry",value:function(e){var t=new c.Tme,r=[],a=[],n=[];t.userData.layers=e.layers,t.userData.groups=e.groups,t.userData.settings=e.settings,t.userData.objectType="File3dm",t.userData.materials=null,t.name=this.url;for(var o=e.objects,s=e.materials,i=0;i<o.length;i++){var l=o[i],u=l.attributes;switch(l.objectType){case"InstanceDefinition":a.push(l);break;case"InstanceReference":n.push(l);break;default:var p=void 0;if(u.materialIndex>=0){var y=s[u.materialIndex],d=this._createMaterial(y);d=this._compareMaterials(d),p=this._createObject(l,d)}else{var h=this._createMaterial();p=this._createObject(l,h)}if(void 0===p)continue;var g=e.layers[u.layerIndex];p.visible=!g||e.layers[u.layerIndex].visible,u.isInstanceDefinitionObject?r.push(p):t.add(p)}}for(var f=0;f<a.length;f++){var m=a[f];o=[];for(var b=0;b<m.attributes.objectIds.length;b++)for(var v=m.attributes.objectIds[b],w=0;w<r.length;w++){v===r[w].userData.attributes.id&&o.push(r[w])}for(var T=0;T<n.length;T++){var k=n[T];if(k.geometry.parentIdefId===m.attributes.id){var x=new c.Tme,_=k.geometry.xform.array,P=new c.yGw;P.set(_[0],_[1],_[2],_[3],_[4],_[5],_[6],_[7],_[8],_[9],_[10],_[11],_[12],_[13],_[14],_[15]),x.applyMatrix4(P);for(var j=0;j<o.length;j++)x.add(o[j].clone(!0));t.add(x)}}}return t.userData.materials=this.materials,t}},{key:"_createObject",value:function(e,t){var r,a,n,o,s=new c.s4_,i=e.attributes;switch(e.objectType){case"Point":case"PointSet":r=s.parse(e.geometry),Object.prototype.hasOwnProperty.call(r.attributes,"color")?a=new c.UY4({vertexColors:!0,sizeAttenuation:!1,size:2}):(n=i.drawColor,o=new c.Ilk(n.r/255,n.g/255,n.b/255),a=new c.UY4({color:o,sizeAttenuation:!1,size:2})),a=this._compareMaterials(a);var l=new c.woe(r,a);return l.userData.attributes=i,l.userData.objectType=e.objectType,i.name&&(l.name=i.name),l;case"Mesh":case"Extrusion":case"SubD":case"Brep":if(null===e.geometry)return;r=s.parse(e.geometry),Object.prototype.hasOwnProperty.call(r.attributes,"color")&&(t.vertexColors=!0),null===t&&(t=this._createMaterial(),t=this._compareMaterials(t));var u=new c.Kj0(r,t);return u.castShadow=i.castsShadows,u.receiveShadow=i.receivesShadows,u.userData.attributes=i,u.userData.objectType=e.objectType,i.name&&(u.name=i.name),u;case"Curve":r=s.parse(e.geometry),n=i.drawColor,o=new c.Ilk(n.r/255,n.g/255,n.b/255),a=new c.nls({color:o}),a=this._compareMaterials(a);var p=new c.x12(r,a);return p.userData.attributes=i,p.userData.objectType=e.objectType,i.name&&(p.name=i.name),p;case"TextDot":r=e.geometry;var y=document.createElement("canvas").getContext("2d"),d="".concat(r.fontHeight,"px ").concat(r.fontFace);y.font=d;var h=y.measureText(r.text).width+10,g=r.fontHeight+10,f=window.devicePixelRatio;y.canvas.width=h*f,y.canvas.height=g*f,y.canvas.style.width=h+"px",y.canvas.style.height=g+"px",y.setTransform(f,0,0,f,0,0),y.font=d,y.textBaseline="middle",y.textAlign="center",o=i.drawColor,y.fillStyle="rgba(".concat(o.r,",").concat(o.g,",").concat(o.b,",").concat(o.a,")"),y.fillRect(0,0,h,g),y.fillStyle="white",y.fillText(r.text,h/2,g/2);var m=new c.ROQ(y.canvas);m.minFilter=c.wem,m.wrapS=c.uWy,m.wrapT=c.uWy,a=new c.xeV({map:m,depthTest:!1});var b=new c.jyi(a);return b.position.set(r.point[0],r.point[1],r.point[2]),b.scale.set(h/10,g/10,1),b.userData.attributes=i,b.userData.objectType=e.objectType,i.name&&(b.name=i.name),b;case"Light":var v;switch((r=e.geometry).lightStyle.name){case"LightStyle_WorldPoint":(v=new c.cek).castShadow=i.castsShadows,v.position.set(r.location[0],r.location[1],r.location[2]),v.shadow.normalBias=.1;break;case"LightStyle_WorldSpot":(v=new c.PMe).castShadow=i.castsShadows,v.position.set(r.location[0],r.location[1],r.location[2]),v.target.position.set(r.direction[0],r.direction[1],r.direction[2]),v.angle=r.spotAngleRadians,v.shadow.normalBias=.1;break;case"LightStyle_WorldRectangular":v=new c.T_f;var w=Math.abs(r.width[2]),T=Math.abs(r.length[0]);v.position.set(r.location[0]-T/2,r.location[1],r.location[2]-w/2),v.height=T,v.width=w,v.lookAt(r.direction[0],r.direction[1],r.direction[2]);break;case"LightStyle_WorldDirectional":(v=new c.Ox3).castShadow=i.castsShadows,v.position.set(r.location[0],r.location[1],r.location[2]),v.target.position.set(r.direction[0],r.direction[1],r.direction[2]),v.shadow.normalBias=.1}return v&&(v.intensity=r.intensity,n=r.diffuse,o=new c.Ilk(n.r/255,n.g/255,n.b/255),v.color=o,v.userData.attributes=i,v.userData.objectType=e.objectType),v}}},{key:"_initLibrary",value:function(){var e=this;if(!this.libraryPending){var t=new c.hH6(this.manager);t.setPath(this.libraryPath);var r=new Promise((function(e,r){t.load("rhino3dm.js",e,void 0,r)})),n=new c.hH6(this.manager);n.setPath(this.libraryPath),n.setResponseType("arraybuffer");var o=new Promise((function(e,t){n.load("rhino3dm.wasm",e,void 0,t)}));this.libraryPending=Promise.all([r,o]).then((function(t){var r=(0,a.Z)(t,2),n=r[0],o=r[1];e.libraryConfig.wasmBinary=o;var s=p.toString(),i=["/* rhino3dm.js */",n,"/* worker */",s.substring(s.indexOf("{")+1,s.lastIndexOf("}"))].join("\n");e.workerSourceURL=URL.createObjectURL(new Blob([i]))}))}return this.libraryPending}},{key:"_getWorker",value:function(e){var t=this;return this._initLibrary().then((function(){if(t.workerPool.length<t.workerLimit){var r=new Worker(t.workerSourceURL);r._callbacks={},r._taskCosts={},r._taskLoad=0,r.postMessage({type:"init",libraryConfig:t.libraryConfig}),r.onmessage=function(e){var a=e.data;switch(a.type){case"warning":t.warnings.push(a.data),console.warn(a.data);break;case"decode":r._callbacks[a.id].resolve(a);break;case"error":r._callbacks[a.id].reject(a);break;default:console.error('THREE.Rhino3dmLoader: Unexpected message, "'+a.type+'"')}},t.workerPool.push(r)}else t.workerPool.sort((function(e,t){return e._taskLoad>t._taskLoad?-1:1}));var a=t.workerPool[t.workerPool.length-1];return a._taskLoad+=e,a}))}},{key:"_releaseTask",value:function(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}},{key:"dispose",value:function(){for(var e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this}}]),r}(c.aNw);function p(){var e,t,r;function a(e,a){var s,i,c,l,u,p=e.geometry(),y=e.attributes(),d=p.objectType;switch(d){case t.ObjectType.Curve:var h=o(p,100);i={},l={},(c={}).itemSize=3,c.type="Float32Array",c.array=[];for(var g=0;g<h.length;g++)c.array.push(h[g][0]),c.array.push(h[g][1]),c.array.push(h[g][2]);i.position=c,l.attributes=i,s={data:l};break;case t.ObjectType.Point:var f=p.location,m={};i={},l={},(c={}).itemSize=3,c.type="Float32Array",c.array=[f[0],f[1],f[2]];var b=y.drawColor(a);m.itemSize=3,m.type="Float32Array",m.array=[b.r/255,b.g/255,b.b/255],i.position=c,i.color=m,l.attributes=i,s={data:l};break;case t.ObjectType.PointSet:case t.ObjectType.Mesh:s=p.toThreejsJSON();break;case t.ObjectType.Brep:var v=p.faces();u=new t.Mesh;for(var w=0;w<v.count;w++){var T=v.get(w),k=T.getMesh(t.MeshType.Any);k&&(u.append(k),k.delete()),T.delete()}u.faces().count>0&&(u.compact(),s=u.toThreejsJSON(),v.delete()),u.delete();break;case t.ObjectType.Extrusion:(u=p.getMesh(t.MeshType.Any))&&(s=u.toThreejsJSON(),u.delete());break;case t.ObjectType.TextDot:s=n(p);break;case t.ObjectType.Light:"LightStyle_WorldLinear"===(s=n(p)).lightStyle.name&&self.postMessage({type:"warning",id:r,data:{message:"THREE.3DMLoader: No conversion exists for ".concat(d.constructor.name," ").concat(s.lightStyle.name),type:"no conversion",guid:y.id}});break;case t.ObjectType.InstanceReference:(s=n(p)).xform=n(p.xform),s.xform.array=p.xform.toFloatArray(!0);break;case t.ObjectType.SubD:p.subdivide(3),(u=t.Mesh.createFromSubDControlNet(p))&&(s=u.toThreejsJSON(),u.delete());break;default:self.postMessage({type:"warning",id:r,data:{message:"THREE.3DMLoader: Conversion not implemented for ".concat(d.constructor.name),type:"not implemented",guid:y.id}})}if(s)return(i=n(y)).geometry=n(p),y.groupCount>0&&(i.groupIds=y.getGroupList()),y.userStringCount>0&&(i.userStrings=y.getUserStrings()),p.userStringCount>0&&(i.geometry.userStrings=p.getUserStrings()),i.drawColor=y.drawColor(a),{geometry:s,attributes:i,objectType:d=(d=d.constructor.name).substring(11,d.length)};self.postMessage({type:"warning",id:r,data:{message:"THREE.3DMLoader: ".concat(d.constructor.name," has no associated mesh geometry."),type:"missing mesh",guid:y.id}})}function n(e){var t={};for(var r in e){var a=e[r];"function"!==typeof a&&("object"===typeof a&&null!==a&&Object.prototype.hasOwnProperty.call(a,"constructor")?t[r]={name:a.constructor.name,value:a.value}:t[r]=a)}return t}function o(e,r){var a=r,n=[],s=[];if(e instanceof t.LineCurve)return[e.pointAtStart,e.pointAtEnd];if(e instanceof t.PolylineCurve){a=e.pointCount;for(var i=0;i<a;i++)n.push(e.point(i));return n}if(e instanceof t.PolyCurve){for(var c=e.segmentCount,l=0;l<c;l++){var u=e.segmentCurve(l),p=o(u,a);n=n.concat(p),u.delete()}return n}if(e instanceof t.ArcCurve&&(a=(a=Math.floor(e.angleDegrees/5))<2?2:a),e instanceof t.NurbsCurve&&1===e.degree){for(var y=e.tryGetPolyline(),d=0;d<y.count;d++)n.push(y.get(d));return y.delete(),n}for(var h=e.domain,g=a-1,f=0;f<a;f++){var m=h[0]+f/g*(h[1]-h[0]);if(m!==h[0]&&m!==h[1]){var b=e.tangentAt(m),v=e.tangentAt(s.slice(-1)[0]),w=b[0]*b[0]+b[1]*b[1]+b[2]*b[2],T=v[0]*v[0]+v[1]*v[1]+v[2]*v[2],k=Math.sqrt(w*T),x=void 0;if(0===k)x=Math.PI/2;else{var _=(b.x*v.x+b.y*v.y+b.z*v.z)/k;x=Math.acos(Math.max(-1,Math.min(1,_)))}x<.1||s.push(m)}else s.push(m)}return n=s.map((function(t){return e.pointAt(t)})),n}onmessage=function(o){var s=o.data;switch(s.type){case"init":var i,c=s.libraryConfig.wasmBinary;e=new Promise((function(e){i={wasmBinary:c,onRuntimeInitialized:e},rhino3dm(i)})).then((function(){t=i}));break;case"decode":r=s.id;var l=s.buffer;e.then((function(){try{var e=function(e,t){for(var o=new Uint8Array(t),s=e.File3dm.fromByteArray(o),i=[],c=[],l=[],u=[],p=[],y=[],d=[],h=s.objects(),g=h.count,f=0;f<g;f++){var m=h.get(f),b=a(m,s);m.delete(),b&&i.push(b)}for(var v=0;v<s.instanceDefinitions().count();v++){var w=s.instanceDefinitions().get(v),T=n(w);T.objectIds=w.getObjectIds(),i.push({geometry:null,attributes:T,objectType:"InstanceDefinition"})}for(var k=[e.TextureType.Diffuse,e.TextureType.Bump,e.TextureType.Transparency,e.TextureType.Opacity,e.TextureType.Emap],x=[e.TextureType.PBR_BaseColor,e.TextureType.PBR_Subsurface,e.TextureType.PBR_SubsurfaceScattering,e.TextureType.PBR_SubsurfaceScatteringRadius,e.TextureType.PBR_Metallic,e.TextureType.PBR_Specular,e.TextureType.PBR_SpecularTint,e.TextureType.PBR_Roughness,e.TextureType.PBR_Anisotropic,e.TextureType.PBR_Anisotropic_Rotation,e.TextureType.PBR_Sheen,e.TextureType.PBR_SheenTint,e.TextureType.PBR_Clearcoat,e.TextureType.PBR_ClearcoatBump,e.TextureType.PBR_ClearcoatRoughness,e.TextureType.PBR_OpacityIor,e.TextureType.PBR_OpacityRoughness,e.TextureType.PBR_Emission,e.TextureType.PBR_AmbientOcclusion,e.TextureType.PBR_Displacement],_=0;_<s.materials().count();_++){for(var P=s.materials().get(_),j=P.physicallyBased(),S=n(P),R=[],M=0;M<k.length;M++){var B=P.getTexture(k[M]);if(B){var C=k[M].constructor.name,D={type:C=C.substring(12,C.length)},O=s.getEmbeddedFileAsBase64(B.fileName);D.wrapU=B.wrapU,D.wrapV=B.wrapV,D.wrapW=B.wrapW;var L=B.uvwTransform.toFloatArray(!0);D.repeat=[L[0],L[5]],O?D.image="data:image/png;base64,"+O:(self.postMessage({type:"warning",id:r,data:{message:"THREE.3DMLoader: Image for ".concat(C," texture not embedded in file."),type:"missing resource"}}),D.image=null),R.push(D),B.delete()}}if(S.textures=R,j.supported){for(var I=0;I<x.length;I++){var A=P.getTexture(x[I]);if(A){var E=s.getEmbeddedFileAsBase64(A.fileName),W=x[I].constructor.name,N={type:W=W.substring(12,W.length),image:"data:image/png;base64,"+E};R.push(N),A.delete()}}var U=n(P.physicallyBased());S=Object.assign(U,S)}c.push(S),P.delete(),j.delete()}for(var z=0;z<s.layers().count();z++){var F=s.layers().get(z),H=n(F);l.push(H),F.delete()}for(var V=0;V<s.views().count();V++){var J=s.views().get(V),G=n(J);u.push(G),J.delete()}for(var Z=0;Z<s.namedViews().count();Z++){var q=s.namedViews().get(Z),Y=n(q);p.push(Y),q.delete()}for(var K=0;K<s.groups().count();K++){var Q=s.groups().get(K),X=n(Q);y.push(X),Q.delete()}for(var $=n(s.settings()),ee=s.strings().count(),te=0;te<ee;te++)d.push(s.strings().get(te));return s.delete(),{objects:i,materials:c,layers:l,views:u,namedViews:p,groups:y,strings:d,settings:$}}(t,l);self.postMessage({type:"decode",id:s.id,data:e})}catch(o){self.postMessage({type:"error",id:s.id,error:o})}}))}}}}}]);